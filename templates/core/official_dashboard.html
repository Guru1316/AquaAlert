{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-wrapper">
    <header class="dashboard-header">
        <h1>AquaAlert - Health Official Dashboard</h1>
        <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
    </header>
    <main class="dashboard-grid">
        <div class="grid-item map-container">
            <h2>Live Health Cases (Last 48 Hours)</h2>
            <div id="map" aria-label="Live health cases map"></div>
        </div>
        <div class="grid-item sidebar">
            <div class="alerts-panel">
                <h2>ðŸš¨ Real-Time Alerts</h2>
                <ul id="alerts-list">
                    <li class="alert-item alert-none">Loading data...</li>
                </ul>
            </div>
            <div class="stats-panel">
                <h2>ðŸ“Š Village Health Snapshot</h2>
                <div id="chart" aria-hidden="false"></div>
            </div>
        </div>
    </main>
</div>

<!-- QR Modal: start hidden; will be centered as popup on all screen sizes -->
<div id="qr-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="qr-title">
    <div class="modal-content" role="document">
        <button class="close-btn" aria-label="Close QR dialog">&times;</button>
        <h2 id="qr-title">Scan to Broadcast SMS</h2>
        <p>Scan this QR code with your phone to open your SMS app with a pre-filled message for the residents of the affected village.</p>
        <div id="qrcode" aria-hidden="false"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/frappe-charts@1.2.4/dist/frappe-charts.min.iife.js"></script>

<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- SECTION 1: INITIALIZE ELEMENTS ---
    let chart = null;
    // ensure map container exists and size is respected by CSS
    const map = L.map('map').setView([26.2006, 92.9376], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markers = L.markerClusterGroup();
    map.addLayer(markers);
    const modal = document.getElementById('qr-modal');
    const closeBtn = modal.querySelector('.close-btn');
    const qrcodeContainer = document.getElementById('qrcode');
    const alertsList = document.getElementById('alerts-list');

    // --- SECTION 2: DEFINE CORE FUNCTIONS ---
    function openModal() {
        modal.classList.remove('hidden');
        // prevent background scroll while modal open
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        // focus for accessibility
        closeBtn.focus();
    }

    function closeModal() {
        modal.classList.add('hidden');
        // restore scrolling
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
        // clear QR to free memory
        qrcodeContainer.innerHTML = '';
    }

    function showQrCodeModal(villageId) {
        const villagePhoneNumbers = {
            'mawlynnong_meghalaya': ['+918825930927', '+919488355023'],
            'ziro_arunachal': ['+919123547685', '+917639222338'],
            'majuli_assam': ['+917010802567', '+917339246139'],
            'khonoma_nagaland': ['+918825930927', '+919488355023'],
            'moirang_manipur': ['+919123547685', '+917639222338'],
            'pelling_sikkim': ['+917010802567', '+917339246139'],
            'champhai_mizoram': ['+918825930927', '+919488355023'],
            'unakoti_tripura': ['+919123547685', '+917639222338']
        };
        const numbers = villagePhoneNumbers[villageId];
        if (!numbers || !Array.isArray(numbers) || numbers.length === 0) {
            alert('Error: No phone numbers are configured for this village.');
            return;
        }
        try {
            const message = `Health Alert! Cases of water-borne illness are rising in your area. Please boil all drinking water. A health team is on its way. \n\nà¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤šà¥‡à¤¤à¤¾à¤µà¤¨à¥€! à¤†à¤ªà¤•à¥‡ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤®à¥‡à¤‚ à¤œà¤²à¤œà¤¨à¤¿à¤¤ à¤¬à¥€à¤®à¤¾à¤°à¥€ à¤•à¥‡ à¤®à¤¾à¤®à¤²à¥‡ à¤¬à¤¢à¤¼ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥€à¤¨à¥‡ à¤•à¤¾ à¤¸à¤¾à¤°à¤¾ à¤ªà¤¾à¤¨à¥€ à¤‰à¤¬à¤¾à¤²à¥‡à¤‚à¥¤ à¤à¤• à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤Ÿà¥€à¤® à¤°à¤¾à¤¸à¥à¤¤à¥‡ à¤®à¥‡à¤‚ à¤¹à¥ˆà¥¤`;
            // For multiple recipients, many phones accept comma-separated list; fallback will be single recipient if needed
            const smsUri = `sms:${numbers.join(',')}?body=${encodeURIComponent(message)}`;

            qrcodeContainer.innerHTML = ''; // Clear previous QR

            // Using the qrcode-generator library
            const typeNumber = 0; // 0 = auto
            const errorCorrectionLevel = 'M'; // Medium gives better readability for phone cameras
            const qr = qrcode(typeNumber, errorCorrectionLevel);
            qr.addData(smsUri);
            qr.make();

            // createImgTag(cellSize, margin) -> returns <img/>
            // Use a moderate cellSize and margin so it looks good on mobile and desktop
            qrcodeContainer.innerHTML = qr.createImgTag(6, 4);

            openModal();
        } catch (e) {
            console.error("QR Code generation failed:", e);
            alert("An error occurred while generating the QR code.");
        }
    }

    async function updateDashboard() {
        try {
            const response = await fetch('/api/dashboard-data/');
            const data = await response.json();
            // Update Alerts
            alertsList.innerHTML = '';
            if (data.alerts && data.alerts.length > 0) {
                data.alerts.forEach(alert => {
                    const li = document.createElement('li');
                    li.className = `alert-item alert-${alert.type}`;
                    li.innerHTML = `<p>${alert.message}</p><button class="broadcast-btn" data-village="${alert.village_id}">Broadcast SMS</button>`;
                    alertsList.appendChild(li);
                });
            } else {
                alertsList.innerHTML = '<li class="alert-item alert-none">No new alerts. System is monitoring...</li>';
            }
            // Update Map
            markers.clearLayers();
            if (data.map_report_data && data.map_report_data.length > 0) {
                data.map_report_data.forEach(report => {
                    const marker = L.circleMarker([report.lat, report.lng], {
                        radius: 6, color: '#dc3545', fillColor: '#dc3545', fillOpacity: 0.7
                    }).bindPopup(`<b>${report.village}</b><br>Symptoms: ${report.symptoms}`);
                    markers.addLayer(marker);
                });
                // optionally fit bounds to markers (commented out: uncomment if desired)
                // const bounds = markers.getBounds();
                // if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
            }
            // Update Chart
            if (!data.chart_data || !data.chart_data.labels.length) {
                document.getElementById('chart').innerHTML = "<p style='text-align:center;color:#6c757d;'>No case data to display.</p>";
            } else if (!chart) {
                chart = new frappe.Chart("#chart", {
                    title: "Cases per Village (48h)", data: data.chart_data, type: 'bar',
                    height: 250, colors: ['#007bff']
                });
            } else {
                chart.update(data.chart_data);
            }
        } catch (error) {
            console.error("Failed to fetch dashboard data:", error);
            alertsList.innerHTML = '<li class="alert-item alert-critical">Could not load dashboard data. Check console.</li>';
        }
    }

    // --- SECTION 3: ATTACH EVENT LISTENERS ---
    alertsList.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('broadcast-btn')) {
            const villageId = event.target.dataset.village;
            showQrCodeModal(villageId);
        }
    });

    closeBtn.addEventListener('click', closeModal);

    // close on overlay click (only if clicked outside .modal-content)
    modal.addEventListener('click', (event) => {
        if (event.target === modal) closeModal();
    });

    // close on ESC key
    document.addEventListener('keydown', (event) => {
        if (event.key === "Escape" && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    // --- SECTION 4: START THE APPLICATION ---
    updateDashboard();
    const dashboardInterval = setInterval(updateDashboard, 10000);

    const sessionCheckInterval = setInterval(() => {
        fetch('/api/session-status/')
            .then(response => {
                if (response.status === 403) {
                    return { authenticated: false, role: null };
                }
                return response.json();
            })
            .then(data => {
                if (!data.authenticated || data.role !== 'official') {
                    alert('Session conflict or logout detected. Redirecting to login page.');
                    window.location.href = "{% url 'auth_page' %}";
                }
            })
            .catch(error => console.error('Session check failed:', error));
    }, 7000); // Check every 7 seconds

    // Cleanup if user navigates away
    window.addEventListener('beforeunload', () => {
        clearInterval(dashboardInterval);
        clearInterval(sessionCheckInterval);
    });

    // Resize handler: when container size changes call map.invalidateSize()
    let resizeDebounce;
    window.addEventListener('resize', () => {
        clearTimeout(resizeDebounce);
        resizeDebounce = setTimeout(() => {
            map.invalidateSize();
        }, 200);
    });
});
</script>
{% endblock %}
